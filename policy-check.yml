name: policy-check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  enforce-pr-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body for required sections
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";

            const requiredSections = [
              "[BA]",
              "[QA]",
              "[SRE]",
              "[DEV]"
            ];

            const missing = requiredSections.filter(section => !body.includes(section));

            if (missing.length > 0) {
              core.setFailed(
                "PR policy violation. Missing required sections: " +
                missing.join(", ") +
                "\n\nEach PR must include sections: [BA], [QA], [SRE], [DEV]"
              );
            }

      - name: Check PR is not targeting main from main
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr.base.ref === "main" && pr.head.ref === "main") {
              core.setFailed("Direct changes to main are not allowed. Use a feature branch.");
            }
