name: Guardrails

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-guardrails:
    name: check-guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enforce audit bot scope (allowlist)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("Guardrails: missing pull_request payload");
              return;
            }

            const isAuditBot = pr.user?.login === "github-actions[bot]";
            const hasAuditLabel = (pr.labels || []).some(label => label.name === "audit:auto");
            const hasOverride = (pr.labels || []).some(label => label.name === "audit:override");

            if (!(isAuditBot && hasAuditLabel)) {
              core.info("Not an audit:auto bot PR; skipping scope enforcement.");
              return;
            }

            if (hasOverride) {
              core.notice("audit:override present; skipping audit bot scope enforcement for this PR.");
              return;
            }

            const { owner, repo } = context.repo;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const allowlist = [
              "EVIDENCE_INDEX.md",
              "EVIDENCE.md",
              "docs/audit/",
              "artifacts/",
              "reports/",
            ];
            const allowedExact = new Set([
              ".github/workflows/automerge_audit_bot_prs.yml",
              ".github/workflows/guardrails.yml",
            ]);

            const invalid = files
              .map(f => f.filename)
              .filter(path => {
                if (allowedExact.has(path)) return false;
                return !allowlist.some(prefix => path === prefix || path.startsWith(prefix));
              });

            if (invalid.length > 0) {
              core.setFailed(`Audit bot PR modifies files outside allowlist: ${invalid.join(", ")}`);
            } else {
              core.info("Audit bot PR limited to allowlist. Guardrails passed.");
            }

      - name: Guardrails
        run: |
          echo "âœ… Guardrails check passed"
