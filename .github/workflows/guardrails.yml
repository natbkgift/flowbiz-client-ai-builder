name: Guardrails

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-guardrails:
    # IMPORTANT: Do NOT include "(pull_request)" in the job name.
    # GitHub UI appends "(pull_request)" automatically on PR runs,
    # producing: "Guardrails / check-guardrails (pull_request)" which matches Ruleset.
    name: check-guardrails
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR description (warn-only)
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if [[ -z "$PR_BODY" ]]; then
            echo "‚ö†Ô∏è PR description is empty (warn-only)"
            echo "Tip: Include [BA][QA][SRE][DEV] markers to satisfy Policy Check."
            exit 0
          fi
          echo "‚úÖ PR description present"

      - name: Check for scope creep (warn-only)
        continue-on-error: true
        run: |
          echo "üîç Checking for out-of-scope patterns..."
          git fetch origin main --depth=1 || true

          DIFF=$(git diff --unified=0 origin/main...HEAD || true)
          SCOPE_VIOLATIONS=$(echo "$DIFF" | grep -iE "(auth|billing|database|queue|cron)" || true)

          if [ -n "$SCOPE_VIOLATIONS" ]; then
            echo "‚ö†Ô∏è Potential scope creep detected (warn-only):"
            echo "$SCOPE_VIOLATIONS"
            echo "Please review changes for out-of-scope features."
          else
            echo "‚úÖ No obvious scope violations detected"
          fi
