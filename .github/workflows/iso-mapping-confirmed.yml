name: iso-mapping-confirmed

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: read

jobs:
  validate-iso-mapping:
    runs-on: ubuntu-latest
    steps:
      - name: Require ISO/SOC2 impact mapping lines in PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";

            // Required impact lines (simple, auditable)
            // Examples:
            // ISO9001_IMPACT: 8.3, 8.6
            // ISO27001_IMPACT: A.12, A.14
            // SOC2_IMPACT: CC5, CC8
            const required = ["ISO9001_IMPACT:", "ISO27001_IMPACT:", "SOC2_IMPACT:"];
            const missing = required.filter(k => !body.includes(k));

            if (missing.length > 0) {
              core.summary
                .addHeading("ISO/SOC2 Mapping — FAILED", 2)
                .addRaw("PR body must include these impact mapping lines:\n\n")
                .addList(missing)
                .addRaw("\nAdd something like:\n\n")
                .addCodeBlock(
                  "ISO9001_IMPACT: 8.3, 8.6\nISO27001_IMPACT: A.12, A.14\nSOC2_IMPACT: CC5, CC8\n\n(If not applicable, use: N/A)",
                  "md"
                );
              await core.summary.write();
              core.setFailed("Missing ISO/SOC2 impact mapping lines in PR body.");
            } else {
              core.summary.addHeading("ISO/SOC2 Mapping — PASSED", 2);
              await core.summary.write();
            }
