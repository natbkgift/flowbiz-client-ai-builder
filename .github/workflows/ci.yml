name: AUTO_RUN Controller

on:
  push:
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: read
  checks: read

concurrency:
  group: autorun-controller
  cancel-in-progress: false

env:
  AUTO_RUN_ISSUE_NUMBER: 1

jobs:
  autorun-after-main-green:
    runs-on: ubuntu-latest

    steps:
      - name: Check required workflows status on this commit
        id: checks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN != '' && secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;

            // workflows ที่ต้องผ่านก่อน AUTO_RUN
            const REQUIRED_CHECKS = [
              "CI",
              "Guardrails",
              "Policy Check",
              "PR Labels"
            ];

            const res = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
              per_page: 100
            });

            const runs = res.data.check_runs;

            const missing = [];
            const failed = [];

            for (const name of REQUIRED_CHECKS) {
              const run = runs.find(r => r.name === name);
              if (!run) {
                missing.push(name);
              } else if (run.conclusion !== "success") {
                failed.push(`${name} (${run.conclusion})`);
              }
            }

            core.info(`Missing checks: ${missing.join(", ")}`);
            core.info(`Failed checks: ${failed.join(", ")}`);

            if (missing.length > 0 || failed.length > 0) {
              core.setOutput("ready", "false");
              return;
            }

            core.setOutput("ready", "true");

      - name: Stop if main is not green
        if: steps.checks.outputs.ready != 'true'
        run: |
          echo "Main branch is not green yet. AUTO_RUN will wait for next push."
          exit 0

      - name: Find open Copilot PRs
        id: prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN != '' && secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;

            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            const hasCopilotPR = prs.data.some(pr =>
              (pr.head.ref || "").startsWith("copilot/")
            );

            core.setOutput("hasCopilotPR", String(hasCopilotPR));

      - name: Stop if Copilot PR already open
        if: steps.prs.outputs.hasCopilotPR == 'true'
        run: |
          echo "Copilot PR already exists. Skip AUTO_RUN."
          exit 0

      - name: Comment to continue AUTO_RUN
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN != '' && secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const ISSUE_NUMBER = parseInt(process.env.AUTO_RUN_ISSUE_NUMBER);

            const body = [
              "@copilot Continue AUTO_RUN from BLUEPRINT.md next milestone.",
              "",
              "**AUTO_RUN Mode Requirements:**",
              "- Follow BLUEPRINT.md strictly (one milestone per PR)",
              "- Open PR as **ready_for_review** (NOT draft)",
              "- Enable **auto-merge** (prefer squash)",
              "- PR must include evidence: [BA][QA][SRE][DEV]",
              "- Do NOT introduce endpoints early",
              "- If any check fails → FAIL_SAFE_HOTFIX_TRIGGERED",
              "",
              "After merge + main green, AUTO_RUN will resume automatically."
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: ISSUE_NUMBER,
              body
            });
