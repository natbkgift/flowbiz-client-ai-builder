name: AUTO_RUN Controller

on:
  workflow_run:
    workflows: ["CI", "Guardrails", "Policy Check", "PR Labels"]
    branches: [main]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: autorun-controller-${{ github.event.workflow_run.workflow_id }}
  cancel-in-progress: false

env:
  # Issue #1 must exist and be maintained as the AUTO_RUN CONTROL issue
  AUTO_RUN_ISSUE_NUMBER: 1
  # AUTORUN_GH_TOKEN secret provides extended permissions for commenting and auto-merge.
  # If not set, github.token is used as fallback with permissions from the workflow's permissions block (issues: write, pull-requests: write).

jobs:
  nudge-copilot-success:
    # Run only when workflow_run is from main branch and succeeds
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Find open PRs by Copilot (skip if one already open)
        id: prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const prs = await github.rest.pulls.list({
              owner, repo,
              state: "open",
              per_page: 100
            });
            // If a PR from a copilot/ branch already exists, stop to avoid duplication
            const hasCopilotPR = prs.data.some(pr => (pr.head.ref || "").startsWith("copilot/"));
            core.setOutput("hasCopilotPR", String(hasCopilotPR));

      - name: Stop if Copilot PR already open
        if: steps.prs.outputs.hasCopilotPR == 'true'
        run: |
          echo "Copilot PR already open. Skip nudging."

      - name: Comment on AUTO_RUN CONTROL issue to continue
        if: steps.prs.outputs.hasCopilotPR != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;

            const ISSUE_NUMBER = parseInt(process.env.AUTO_RUN_ISSUE_NUMBER);

            // Verify the issue exists before attempting to comment
            try {
              await github.rest.issues.get({
                owner,
                repo,
                issue_number: ISSUE_NUMBER
              });
            } catch (error) {
              core.setFailed(`AUTO_RUN CONTROL issue #${ISSUE_NUMBER} does not exist. Please create it first.`);
              return;
            }

            const body = [
              "@copilot Continue AUTO_RUN from BLUEPRINT.md next milestone (per AUTO-RUN CONTINUITY Â§8.1).",
              "",
              "**AUTO_RUN Mode Requirements:**",
              "- Follow BLUEPRINT.md strictly (one phase per PR)",
              "- Open PR as **ready_for_review** (NOT draft)",
              "- Resolve all PR conversations (review threads) before enabling auto-merge",
              "- Do NOT merge while any conversation is unresolved",
              "- Enable **auto-merge** on the PR",
              "- PR must include evidence from all sections: [BA][QA][SRE][DEV]",
              "- Restate the active milestone, dependencies, and evidence mapping in each PR body to keep the chain audit-ready",
              "- After merge, immediately open the next PR for the next uncompleted milestone (one milestone per PR)",
              "- If paused, emit CONTROLLED_HALT with reason; resume automatically once unblocked",
              "- Do NOT introduce endpoints early",
              "- If any check fails â†’ FAIL_SAFE_HOTFIX_TRIGGERED, fix first before continuing",
              "",
              "After merge + main green, remain in AUTO_RUN and proceed to the next milestone without manual confirmation.",
            ].join("\n");

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: ISSUE_NUMBER,
              body
            });

  fail-safe-hotfix-trigger:
    # Run only when workflow_run is from main branch and fails
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Find open PRs by Copilot (skip if one already open)
        id: prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const prs = await github.rest.pulls.list({
              owner, repo,
              state: "open",
              per_page: 100
            });
            const hasCopilotPR = prs.data.some(pr => (pr.head.ref || "").startsWith("copilot/"));
            core.setOutput("hasCopilotPR", String(hasCopilotPR));

      - name: Stop if Copilot PR already open
        if: steps.prs.outputs.hasCopilotPR == 'true'
        run: |
          echo "Copilot PR already open. Skip FAIL_SAFE trigger."

      - name: Trigger FAIL_SAFE_HOTFIX on AUTO_RUN CONTROL issue
        if: steps.prs.outputs.hasCopilotPR != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;

            const ISSUE_NUMBER = parseInt(process.env.AUTO_RUN_ISSUE_NUMBER);

            // Verify the issue exists before attempting to comment
            try {
              await github.rest.issues.get({
                owner,
                repo,
                issue_number: ISSUE_NUMBER
              });
            } catch (error) {
              core.setFailed(`AUTO_RUN CONTROL issue #${ISSUE_NUMBER} does not exist. Please create it first.`);
              return;
            }

            const workflowName = context.payload.workflow_run.name;
            const workflowUrl = context.payload.workflow_run.html_url;

            const body = [
              "ðŸš¨ **FAIL_SAFE_HOTFIX_TRIGGERED** ðŸš¨",
              "",
              `Workflow \`${workflowName}\` failed on main branch.`,
              `View failure: ${workflowUrl}`,
              "",
              "@copilot STOP all new features. Fix the failing workflow first.",
              "",
              "**Hotfix Requirements:**",
              "- Create hotfix PR to fix the failing check",
              "- Open PR as **ready_for_review** (NOT draft)",
              "- Enable **auto-merge** on the PR",
              "- PR title must start with: `HOTFIX:`",
              "- PR must fix ONLY the failing check (minimal change)",
              "- After merge + main green, AUTO_RUN will resume automatically",
            ].join("\n");

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: ISSUE_NUMBER,
              body
            });
