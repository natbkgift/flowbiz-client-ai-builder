name: AUTO_RUN Controller

on:
  workflow_run:
    # Trigger when CI on main completes (after merge to main)
    workflows: ["CI"]
    branches: [main]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: autorun-controller
  cancel-in-progress: false

env:
  AUTO_RUN_ISSUE_NUMBER: 1

jobs:
  nudge-agent-on-success:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Find open PRs (skip if any open PR exists)
        id: prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const prs = await github.rest.pulls.list({
              owner, repo,
              state: "open",
              per_page: 100
            });
            const hasOpenPR = prs.data.length > 0;
            core.setOutput("hasOpenPR", String(hasOpenPR));

      - name: Stop if any PR already open
        if: steps.prs.outputs.hasOpenPR == 'true'
        run: |
          echo "An open PR already exists. Skip AUTO_RUN nudge."

      - name: Comment on AUTO_RUN CONTROL issue to continue
        if: steps.prs.outputs.hasOpenPR != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const ISSUE_NUMBER = Number(process.env.AUTO_RUN_ISSUE_NUMBER);

            const body = [
              "@copilot Continue AUTO_RUN from BLUEPRINT.md next milestone.",
              "",
              "**Runbook (hard rules):**",
              "- Read BLUEPRINT.md, pick NEXT uncompleted milestone only (ONE PR = ONE milestone)",
              "- Open PR as READY_FOR_REVIEW (NOT draft)",
              "- Keep scope minimal; no refactors unless required",
              "- Ensure PR body includes [BA][QA][SRE][DEV] + MILESTONE_ID + BLUEPRINT_REF",
              "- Fix failing checks until ALL required checks are green",
              "- Enable auto-merge (squash) if allowed",
              "- After merge + main green, this controller triggers again",
              "",
              "**Fail-safe:** If main CI fails â†’ create HOTFIX PR first, restore main to green, then continue.",
            ].join("\n");

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: ISSUE_NUMBER,
              body
            });

  fail-safe-hotfix-trigger:
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Find open PRs (skip if any open PR exists)
        id: prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const prs = await github.rest.pulls.list({
              owner, repo,
              state: "open",
              per_page: 100
            });
            const hasOpenPR = prs.data.length > 0;
            core.setOutput("hasOpenPR", String(hasOpenPR));

      - name: Stop if any PR already open
        if: steps.prs.outputs.hasOpenPR == 'true'
        run: |
          echo "An open PR already exists. Skip FAIL_SAFE nudge."

      - name: Trigger FAIL_SAFE_HOTFIX on AUTO_RUN CONTROL issue
        if: steps.prs.outputs.hasOpenPR != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTORUN_GH_TOKEN || github.token }}
          script: |
            const { owner, repo } = context.repo;
            const ISSUE_NUMBER = Number(process.env.AUTO_RUN_ISSUE_NUMBER);

            const workflowName = context.payload.workflow_run.name;
            const workflowUrl = context.payload.workflow_run.html_url;

            const body = [
              "ðŸš¨ **FAIL_SAFE_HOTFIX_TRIGGERED** ðŸš¨",
              "",
              `Workflow \`${workflowName}\` failed on main branch.`,
              `View failure: ${workflowUrl}`,
              "",
              "@copilot STOP all new features. Fix the failing workflow first.",
              "",
              "**Hotfix Requirements:**",
              "- Create hotfix PR to fix ONLY the failing check (minimal change)",
              "- PR title must start with: `HOTFIX:`",
              "- Open PR as READY_FOR_REVIEW (NOT draft)",
              "- Fix until checks are green, then enable auto-merge (squash) if allowed",
              "- After merge + main green, AUTO_RUN will resume automatically",
            ].join("\n");

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: ISSUE_NUMBER,
              body
            });
